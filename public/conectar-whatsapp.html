<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Conectar WhatsApp ‚Äì ComercioAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png">
  <link rel="stylesheet" href="comercioai.css">
</head>
<body>
  <!-- === Header commun === -->
  <header class="ca-header">
    <div class="ca-header-3col">
      <div class="ca-header-left">
        <a href="index.html" class="ca-logo-icon">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
        </a>
        <a href="index.html" class="ca-logo-text-img">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
        </a>
      </div>
      <nav class="ca-header-center" id="nav-center"></nav>
      <div id="auth-buttons" class="nav-login"></div>
    </div>
    <!-- Version mobile -->
    <div class="ca-header-mobile">
      <div class="ca-header-left">
        <a href="index.html" class="ca-logo-icon">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
        </a>
        <a href="index.html" class="ca-logo-text-img">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
        </a>
      </div>
      <div class="ca-header-mobile-actions" id="mobile-actions"></div>
      <button class="ca-hamburger" id="caHamburgerBtn" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>
    <nav class="ca-mobile-menu" id="caMobileMenu"></nav>
  </header>

  <!-- === Contenu principal === -->
  <main class="ca-main">
    <section class="ca-section">
      <h1>Conectar WhatsApp</h1>
      <p class="ca-subtext">Conecta tu n√∫mero de WhatsApp API para activar las respuestas autom√°ticas de tu asistente.</p>

      <!-- Carte de status -->
      <div class="ca-card" id="statusCard">
        <h3>Estado de conexi√≥n</h3>
        <p id="statusText">Cargando...</p>
      </div>

      <!-- Boutons -->
      <div class="ca-actions">
        <button id="testBtn" class="ca-btn ca-btn-primary">Probar conexi√≥n (Simulado)</button>
        <button id="signupBtn" class="ca-btn ca-btn-disabled" title="Disponible tras aprobaci√≥n Tech Provider">
          Iniciar Embedded Signup
        </button>
      </div>

      <!-- Ruban alerte -->
      <div id="alertBanner" class="ca-alert ca-alert-warning" style="display:none;">
        ‚ö†Ô∏è Conecta tu WhatsApp API para activar respuestas autom√°ticas
      </div>

      <!-- Toggle auto-reply -->
      <div class="ca-toggle">
        <label>
          <input type="checkbox" id="autoReplyToggle" disabled>
          Activar respuestas autom√°ticas
        </label>
      </div>

      <!-- Logs -->
      <div class="ca-card ca-logs">
        <h3>Logs</h3>
        <pre id="logPanel">Esperando eventos...</pre>
      </div>
    </section>
    <section class="ca-section">
      <h2>N√∫mero de WhatsApp (solo captura)</h2>
      <p class="ca-subtext">Introduce tu n√∫mero en formato E.164 (ej: +573001234567). A√∫n no conectamos el WABA.</p>
    
      <div class="ca-card">
        <label for="waNumber">N√∫mero (E.164)</label>
        <input id="waNumber" type="text" class="ca-input" placeholder="+573001234567" autocomplete="tel" />
    
        <div class="ca-actions">
          <button id="btnValidate" class="ca-btn">Validar formato</button>
          <button id="btnSaveDraft" class="ca-btn ca-btn-primary">Guardar n√∫mero</button>
        </div>
    
        <div id="numMsg" class="ca-alert" style="display:none;"></div>
      </div>
    </section>
    <button id="btnEmbedded" class="ca-btn ca-btn-primary">Iniciar Embedded Signup</button>
    <section id="number-registration">
      <h2>Registro de N√∫mero (si WABA sin n√∫mero)</h2>
      <p>Si tu WABA no tiene un n√∫mero utilizable, reg√≠stralo aqu√≠.</p>
    
      <!-- Input pour num√©ro E.164 (utilise /api/whatsapp/number/draft si besoin) -->
      <label for="wa-number">N√∫mero WhatsApp (E.164, ej: +573001234567):</label>
      <input type="text" id="wa-number" placeholder="+573001234567">
      <button id="save-number">Guardar N√∫mero</button>
    
      <!-- Boutons pour la s√©quence -->
      <div>
        <button id="request-code">Enviar C√≥digo (SMS)</button>
        <input type="text" id="verification-code" placeholder="C√≥digo de 6 d√≠gitos" maxlength="6">
        <button id="verify-code">Verificar C√≥digo</button>
        <button id="register-number">Registrar N√∫mero</button>
      </div>
    
      <!-- Test d‚Äôenvoi -->
      <div>
        <label for="test-to">Enviar test a (E.164):</label>
        <input type="text" id="test-to" placeholder="+573001234567">
        <button id="send-test">Probar Envio</button>
      </div>
    
      <!-- Logs (append des √©v√©nements) -->
      <div id="logs">
        <h3>Logs</h3>
        <ul></ul>
      </div>
    </section>
  </main>

  <!-- === Footer commun === -->
  <footer class="ca-footer">
    &copy; 2025 ComercioAI ‚Äì Todos los derechos reservados.
    <a href="contacto.html">Cont√°ctanos</a>
    <a href="politica-de-privacidad.html" target="_blank">Pol√≠tica de Privacidad</a>
    <a href="eliminar-datos.html" target="_blank">Eliminar mis datos</a>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id) => document.getElementById(id);
  
    // --- Auth header ---
    (async function initHeaderAuth() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        const box = $('auth-buttons');
        if (res.ok) {
          const me = await res.json();
          if (box) box.innerHTML = `üëã Hola, ${me.name || me.email}`;
        } else {
          if (box) box.innerHTML = `<a href="login.html" class="ca-btn">Iniciar sesi√≥n</a>`;
        }
      } catch {}
    })();
  
    // --- E.164 utils ---
    const isE164 = (s) => /^\+[1-9]\d{7,14}$/.test(String(s).trim());
    const showMsg = (ok, text) => {
      const box = $('numMsg');
      if (!box) return;
      box.className = 'ca-alert ' + (ok ? 'ca-alert-success' : 'ca-alert-warning');
      box.textContent = text;
      box.style.display = 'block';
    };
  
    // --- Charger le draft si dispo ---
    (async function loadDraft() {
      try {
        const r = await fetch('/api/whatsapp/number/draft', { credentials: 'include' });
        if (!r.ok) return;
        const d = await r.json();
        if (d?.waNumber) $('waNumber').value = d.waNumber;
      } catch {}
    })();
  
    // --- Handlers boutons ---
    const btnValidate = $('btnValidate');
    const btnSaveDraft = $('btnSaveDraft');
    const waNumber = $('waNumber');
  
    if (btnValidate && waNumber) {
      btnValidate.onclick = () => {
        const v = waNumber.value.trim();
        if (isE164(v)) showMsg(true, '‚úÖ Formato v√°lido (E.164).');
        else showMsg(false, '‚ùå Formato inv√°lido. Debe ser +c√≥digoPa√≠s + d√≠gitos (8‚Äì15).');
      };
    }
  
    if (btnSaveDraft && waNumber) {
      btnSaveDraft.onclick = async () => {
        const v = waNumber.value.trim();
        if (!isE164(v)) return showMsg(false, '‚ùå Corrige el formato antes de guardar.');
        try {
          const r = await fetch('/api/whatsapp/number/draft', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ waNumber: v })
          });
          const d = await r.json().catch(() => ({}));
          if (!r.ok) return showMsg(false, d?.error || '‚ùå Error guardando n√∫mero.');
          showMsg(true, '‚úÖ N√∫mero guardado como borrador.');
        } catch {
          showMsg(false, '‚ùå Error de red.');
        }
      };
    }
  
    // --- Embedded Signup ---
    const btnEmbedded = $('btnEmbedded');
    if (btnEmbedded) {
      btnEmbedded.addEventListener('click', async () => {
        try {
          const r = await fetch('/api/whatsapp/embedded/start', { credentials:'include' });
          if (!r.ok) return alert('No se pudo iniciar ESU');
          const { url } = await r.json();
          window.location.href = url;
        } catch {
          alert('Error iniciando ESU');
        }
      });
    }
  });
  </script>
  <script>
    async function refreshStatus(){
      try{
        const r = await fetch('/api/whatsapp/status', { credentials:'include' });
        const s = await r.json();
        const txt = s.connected
          ? `‚úÖ Conectado (producci√≥n) ‚Äì phone_number_id: ${s.phoneNumberIdMasked || '‚Äî'}`
          : '‚ùå No conectado';
        const el = document.getElementById('statusText');
        if (el) el.textContent = txt;
      }catch{
        const el = document.getElementById('statusText');
        if (el) el.textContent = 'Error al cargar estado.';
      }
    }
    document.addEventListener('DOMContentLoaded', refreshStatus);
  </script>
  <script>
    const logsList = document.querySelector('#logs ul');
    function logMessage(msg) {
      const li = document.createElement('li');
      li.textContent = new Date().toISOString() + ' - ' + msg;
      logsList.appendChild(li);
    }
  
    // Charger num√©ro draft si existe
    fetch('/api/whatsapp/number/draft')
      .then(res => res.json())
      .then(data => {
        if (data.waNumber) document.getElementById('wa-number').value = data.waNumber;
      })
      .catch(err => logMessage('Error cargando draft: ' + err.message));
  
    // Guardar n√∫mero
    document.getElementById('save-number').addEventListener('click', () => {
      const waNumber = document.getElementById('wa-number').value.trim();
      if (!waNumber.startsWith('+') || waNumber.length < 12) {
        alert('Formato E.164 inv√°lido');
        return;
      }
      fetch('/api/whatsapp/number/draft', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ waNumber })
      })
      .then(res => res.json())
      .then(data => logMessage('N√∫mero guardado: ' + data.waNumber))
      .catch(err => logMessage('Error guardando n√∫mero: ' + err.message));
    });
  
    // Envoyer code
    document.getElementById('request-code').addEventListener('click', () => {
      fetch('/api/whatsapp/number/request-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code_method: 'SMS', locale: 'es_ES' })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) logMessage('C√≥digo solicitado OK');
        else alert(data.error);
      })
      .catch(err => logMessage('Error request-code: ' + err.message));
    });
  
    // V√©rifier code
    document.getElementById('verify-code').addEventListener('click', () => {
      const code = document.getElementById('verification-code').value.trim();
      if (code.length !== 6) return alert('C√≥digo de 6 d√≠gitos requerido');
      fetch('/api/whatsapp/number/verify-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) logMessage('C√≥digo verificado OK');
        else alert(data.error);
      })
      .catch(err => logMessage('Error verify-code: ' + err.message));
    });
  
    // Register
    document.getElementById('register-number').addEventListener('click', () => {
      fetch('/api/whatsapp/number/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messaging_product: 'whatsapp' }) // Ajouter pin si besoin
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) logMessage('Registro OK: ' + data.message);
        else alert(data.error);
      })
      .catch(err => logMessage('Error register: ' + err.message));
    });
  
    // Test envoi
    document.getElementById('send-test').addEventListener('click', () => {
      const to = document.getElementById('test-to').value.trim();
      if (!to) return alert('N√∫mero destinatario requerido');
      fetch('/api/whatsapp/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) logMessage('Test enviado OK, ID: ' + data.messageId);
        else alert(data.error);
      })
      .catch(err => logMessage('Error test send: ' + err.message));
    });
  
    // Refresh status apr√®s actions (optionnel, poll /api/whatsapp/status)
  </script>
</body>
</html>









