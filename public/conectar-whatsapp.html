<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Conectar WhatsApp ‚Äì ComercioAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png">
  <link rel="stylesheet" href="comercioai.css">
</head>
<body>
  <!-- === Header commun === -->
  <header class="ca-header">
    <div class="ca-header-3col">
      <div class="ca-header-left">
        <a href="index.html" class="ca-logo-icon">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
        </a>
        <a href="index.html" class="ca-logo-text-img">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
        </a>
      </div>
      <nav class="ca-header-center" id="nav-center"></nav>
      <div id="auth-buttons" class="nav-login"></div>
    </div>
    <!-- Version mobile -->
    <div class="ca-header-mobile">
      <div class="ca-header-left">
        <a href="index.html" class="ca-logo-icon">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
        </a>
        <a href="index.html" class="ca-logo-text-img">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
        </a>
      </div>
      <div class="ca-header-mobile-actions" id="mobile-actions"></div>
      <button class="ca-hamburger" id="caHamburgerBtn" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>
    <nav class="ca-mobile-menu" id="caMobileMenu"></nav>
  </header>

  <!-- === Contenu principal === -->
  <main class="ca-main">
    <section class="ca-section">
      <h1>Conectar WhatsApp</h1>
      <p class="ca-subtext">Conecta tu n√∫mero de WhatsApp API para activar las respuestas autom√°ticas de tu asistente.</p>

      <!-- Carte de status -->
      <div class="ca-card" id="statusCard">
        <h3>Estado de conexi√≥n</h3>
        <p id="statusText">Cargando...</p>
      </div>
    </section>
    
    <!-- Panel de s√©lection post-ESU -->
    <section id="wa-candidates" class="ca-card" style="display:none; margin-top:16px;">
      <div class="ca-card-body">
        <h3 class="ca-title">Selecciona el n√∫mero para conectar</h3>
        <p class="ca-muted" id="wa-candidates-desc">
          Hemos recibido los datos de Meta. Confirma qu√© n√∫mero quieres conectar a tu asistente.
        </p>
    
        <div id="wa-candidates-loading" class="ca-loading" style="margin:12px 0; display:none;">
          Cargando opciones‚Ä¶
        </div>
    
        <div id="wa-candidates-error" class="ca-alert ca-alert-error" style="display:none;"></div>
    
        <div id="wa-candidates-list" class="ca-list" style="display:none;"></div>
    
        <div id="wa-candidates-empty" class="ca-alert ca-alert-info" style="display:none;">
          No encontramos n√∫meros disponibles con tu cuenta actual. Verifica permisos o vuelve a iniciar el ESU.
          <div style="margin-top:8px;">
            <button id="btn-retry-esu" class="ca-btn ca-btn-primary">Volver a iniciar ESU</button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Panel √©xito -->
    <section id="wa-success" class="ca-card" style="display:none; margin-top:16px;">
      <div class="ca-card-body">
        <h3 class="ca-title">‚úÖ Conectado correctamente</h3>
        <p class="ca-muted" id="wa-success-desc"></p>
        <div style="margin-top:8px;">
          <a class="ca-btn" href="/agenda.html">Probar con un mensaje</a>
          <a class="ca-btn ca-btn-ghost" href="/">Volver al inicio</a>
        </div>
      </div>
    </section>
    
    <!-- Panel error gen√©rico -->
    <section id="wa-generic-error" class="ca-card" style="display:none; margin-top:16px;">
      <div class="ca-card-body">
        <h3 class="ca-title">‚ùå Error durante la conexi√≥n</h3>
        <p class="ca-muted">Intenta nuevamente o inicia de nuevo el Embedded Signup.</p>
        <div style="margin-top:8px;">
          <button id="btn-retry-esu-2" class="ca-btn ca-btn-primary">Volver a iniciar ESU</button>
        </div>
      </div>
    </section>
    
    <button id="btnEmbedded" class="ca-btn ca-btn-primary">Iniciar Embedded Signup</button>
  </main>

  <!-- === Footer commun === -->
  <footer class="ca-footer">
    &copy; 2025 ComercioAI ‚Äì Todos los derechos reservados.
    <a href="contacto.html">Cont√°ctanos</a>
    <a href="politica-de-privacidad.html" target="_blank">Pol√≠tica de Privacidad</a>
    <a href="eliminar-datos.html" target="_blank">Eliminar mis datos</a>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (id) => document.getElementById(id);
  
    // --- Auth header ---
    (async function initHeaderAuth() {
      try {
        const res = await fetch('/api/me', { credentials: 'include' });
        const box = $('auth-buttons');
        if (res.ok) {
          const me = await res.json();
          if (box) box.innerHTML = `üëã Hola, ${me.name || me.email}`;
        } else {
          if (box) box.innerHTML = `<a href="login.html" class="ca-btn">Iniciar sesi√≥n</a>`;
        }
      } catch {}
    })();
  
    // --- Embedded Signup ---
    const btnEmbedded = $('btnEmbedded');
    if (btnEmbedded) {
      btnEmbedded.addEventListener('click', async () => {
        try {
          const r = await fetch('/api/whatsapp/embedded/start', { credentials:'include' });
          if (!r.ok) {
            const msg = (await r.json().catch(()=>({})))?.error || `HTTP ${r.status}`;
            return alert(`No se pudo iniciar ESU: ${msg}`);
          }
          const { url } = await r.json();
          window.location.href = url;
        } catch (e) {
          alert('Error iniciando ESU');
        }
      });
    }
  });
  </script>
  <script>
    async function refreshStatus(){
      try{
        const r = await fetch('/api/whatsapp/status', { credentials:'include' });
        const s = await r.json();
        const txt = s.connected
          ? `‚úÖ Conectado (producci√≥n) ‚Äì phone_number_id: ${s.phoneNumberIdMasked || '‚Äî'}`
          : '‚ùå No conectado';
        const el = document.getElementById('statusText');
        if (el) el.textContent = txt;
      }catch{
        const el = document.getElementById('statusText');
        if (el) el.textContent = 'Error al cargar estado.';
      }
    }
    document.addEventListener('DOMContentLoaded', refreshStatus);
  </script>
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const params = new URLSearchParams(window.location.search);
  if (params.get("esu") === "ok") {
    alert("‚úÖ WhatsApp conectado con √©xito. Redirigiendo al dashboard...");
    window.location.href = "dashboard.html"; // ‚úÖ derni√®re √©tape
  } else if (params.get("esu") === "error") {
    alert("‚ùå Error durante la conexi√≥n. Intenta de nuevo.");
  }
});
</script>
<script>
  (function() {
    const qs = new URLSearchParams(location.search);
  
    // Elements
    const elPanel      = document.getElementById('wa-candidates');
    const elList       = document.getElementById('wa-candidates-list');
    const elLoading    = document.getElementById('wa-candidates-loading');
    const elEmpty      = document.getElementById('wa-candidates-empty');
    const elErr        = document.getElementById('wa-candidates-error');
    const elSuccess    = document.getElementById('wa-success');
    const elSuccessTxt = document.getElementById('wa-success-desc');
    const elGenericErr = document.getElementById('wa-generic-error');
  
    const btnRetry1    = document.getElementById('btn-retry-esu');
    const btnRetry2    = document.getElementById('btn-retry-esu-2');
  
    const AUTO_CONNECT_SINGLE = false; // ‚Üê passe √† true si tu veux auto-connecter quand il n‚Äôy a qu‚Äôun seul candidat
  
    function show(node) { node && (node.style.display = ''); }
    function hide(node) { node && (node.style.display = 'none'); }
    function htmlSafe(s) {
      return String(s || '').replace(/[&<>"]/g, c => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]
      ));
    }
  
    async function fetchStatus() {
      const r = await fetch('/api/whatsapp/status', { credentials: 'include', cache: 'no-store' });
      if (!r.ok) throw new Error('STATUS_HTTP_' + r.status);
      return r.json();
    }
    async function fetchCandidates() {
      const r = await fetch('/api/whatsapp/candidates', { credentials: 'include', cache: 'no-store' });
      if (!r.ok) throw new Error('CAND_HTTP_' + r.status);
      return r.json();
    }
  
    async function postConnect(body) {
      const r = await fetch('/api/whatsapp/connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(body)
      });
      if (!r.ok) {
        let errTxt = 'CONNECT_HTTP_' + r.status;
        try { const j = await r.json(); if (j && j.error) errTxt = j.error; } catch {}
        throw new Error(errTxt);
      }
      return r.json();
    }
  
    function renderCandidates(list) {
      elList.innerHTML = '';
      list.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'ca-list-row';
  
        row.innerHTML = `
          <div class="ca-list-col">
            <div class="ca-kicker">${htmlSafe(c.businessName)} ¬∑ ${htmlSafe(c.wabaName)}</div>
            <div class="ca-strong">üìû ${htmlSafe(c.waNumber || '(sin n√∫mero)')}</div>
            <div class="ca-sub">WABA ID: ${htmlSafe(c.wabaId)} ¬∑ Phone ID: ${htmlSafe(c.phoneNumberId)}</div>
          </div>
          <div class="ca-list-col-auto">
            <button class="ca-btn" data-idx="${idx}">Conectar este n√∫mero</button>
          </div>
        `;
        elList.appendChild(row);
      });
  
      // Bind buttons
      elList.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', async (ev) => {
          const i = Number(ev.currentTarget.getAttribute('data-idx'));
          const chosen = list[i];
          if (!chosen) return;
  
          btn.disabled = true; btn.textContent = 'Conectando‚Ä¶';
          hide(elErr);
  
          try {
            const resp = await postConnect({ wabaId: chosen.wabaId, phoneNumberId: chosen.phoneNumberId });
            // success
            hide(elPanel);
            show(elSuccess);
            elSuccessTxt.textContent = `N√∫mero ${chosen.waNumber} conectado (${chosen.wabaId}).`;
          } catch (e) {
            show(elErr);
            elErr.textContent = 'No se pudo conectar: ' + (e.message || e);
            btn.disabled = false; btn.textContent = 'Conectar este n√∫mero';
          }
        });
      });
    }
  
    // ...
    async function init() {
      const esu = qs.get('esu');
    
      // si esu=success -> panneau succ√®s
      if (esu === 'success') { /* ... */ return; }
    
      // si esu=confirm -> on force le panneau et on charge la liste
      if (esu === 'confirm') {
        hide(elGenericErr);
        show(elPanel);
        hide(elEmpty); hide(elErr);
        show(elLoading);
        try {
          const cands = await fetchCandidates(); // GET /api/whatsapp/candidates
          hide(elLoading);
          const list = Array.isArray(cands?.candidates) ? cands.candidates : [];
          if (!list.length) { show(elEmpty); return; }
          show(elList);
          renderCandidates(list);
        } catch (e) {
          hide(elLoading);
          show(elErr);
          elErr.textContent = 'No se pudieron cargar los candidatos. Intenta nuevamente.';
        }
        return;
      }
    
      // sinon: flow normal par /status
      let status;
      try { status = await fetchStatus(); } catch { show(elGenericErr); return; }
      if (status?.connected) { /* show success ... */ return; }
      if (status?.selectionPending) {
        hide(elGenericErr); show(elPanel); show(elLoading);
        try {
          const cands = await fetchCandidates();
          hide(elLoading);
          const list = Array.isArray(cands?.candidates) ? cands.candidates : [];
          if (!list.length) { show(elEmpty); return; }
          show(elList); renderCandidates(list);
        } catch { hide(elLoading); show(elErr); }
        return;
      }
      show(elGenericErr);
    }

  
    // Boutons "Reiniciar ESU"
    function goStartESU() {
      // On relance le start pour r√©cup√©rer la nouvelle URL
      fetch('/api/whatsapp/embedded/start', { credentials:'include' })
        .then(r => r.json())
        .then(j => {
          if (j && j.url) location.href = j.url;
          else alert('No se pudo iniciar ESU. Revisa tu sesi√≥n.');
        })
        .catch(() => alert('No se pudo iniciar ESU.'));
    }
  
    btnRetry1 && btnRetry1.addEventListener('click', goStartESU);
    btnRetry2 && btnRetry2.addEventListener('click', goStartESU);
  
    // Go
    init();
  })();
  </script>
</body>
</html>

















