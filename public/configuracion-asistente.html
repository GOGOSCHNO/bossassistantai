<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Configuraci√≥n del Asistente ‚Äì Comercio AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="comercioai.css">
  <link rel="icon" href="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" type="image/x-icon">
</head>
<body>
  <div class="overlay">
    <header class="ca-header">
      <div class="ca-header-3col">
        <div class="ca-header-left">
          <a href="index.html" class="ca-logo-icon">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
          </a>
          <a href="index.html" class="ca-logo-text-img">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
          </a>
        </div>
        <nav class="ca-header-center" id="nav-center">
          <a href="precio.html" class="ca-btn nav-btn">Ver planes</a>
          <a href="dashboard.html" class="ca-btn ca-btn-primary">Dashboard</a>
        </nav>
        <div id="auth-buttons" class="ca-header-right"></div>
      </div>
    </header>
    <main>
      <div id="progress-bar-container">
        <div id="progress-bar"></div>
      </div>
      <div class="form-container">
        <h2>‚öôÔ∏è Configuraci√≥n del asistente</h2>
    
        <!-- √âtape 0 : Choix entre MayIA et SofIA -->
        <div class="form-step" id="step0">
          <h2>¬øCu√°l asistente deseas usar?</h2>
          <div class="assistant-selection">
            <div class="assistant-option" id="mayia">
              <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/patricia%20feliz.png" alt="MayIA">
              <h3>MayIA</h3>
              <p>Ideal para negocios de productos f√≠sicos o digitales.</p>
            </div>
            <div class="assistant-option" id="sofia">
              <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/Clara.png" alt="SofIA">
              <h3>SofIA</h3>
              <p>Perfecta para servicios como belleza, salud, reservas‚Ä¶</p>
            </div>
          </div>
        </div>
    
        <!-- √âtape dynamique -->
        <div id="dynamic-form-container"></div>
      </div>
    </main>
    <footer class="ca-footer">
      &copy; 2025 Comercio AI ‚Äì Todos los derechos reservados.
      <a href="contacto.html">Cont√°ctanos</a>
      <a href="politica-de-privacidad.html" target="_blank">Pol√≠tica de Privacidad</a>
    </footer>
  </div>
  <script>
  window.addEventListener("DOMContentLoaded", async () => {
    let camposExtra = [];
  
    function agregarCampoExtra() {
      const nombreCampo = prompt("Nombre del nuevo campo (ej: Duraci√≥n, Categor√≠a):");
      if (nombreCampo) {
        camposExtra.push(nombreCampo);
        actualizarCamposProducto(document.querySelector(".producto-item:last-child"));
      }
    }
    
    function actualizarCamposProducto(contenedor) {
      camposExtra.forEach(campo => {
        const label = document.createElement("label");
        label.textContent = campo;
        const input = document.createElement("input");
        input.type = "text";
        input.className = `producto-${campo.toLowerCase()}`;
        input.placeholder = `Ej: valor para ${campo}`;
        contenedor.appendChild(label);
        contenedor.appendChild(input);
      });
    }
    let currentStep = 0;
    let selectedAssistant = null;
    const progressBar = document.getElementById("progress-bar");
    const dynamicContainer = document.getElementById("dynamic-form-container");
    
    function updateProgressBar(stepIndex) {
      const percent = Math.min((stepIndex / 4) * 100, 100);
      progressBar.style.width = `${percent}%`;
    }
    
    function showStep0() {
      document.getElementById("step0").style.display = "block";
      dynamicContainer.innerHTML = "";
      updateProgressBar(0);
    }
    
    function loadFormForMayIA() {
      dynamicContainer.innerHTML = `
        <h3>Informaci√≥n b√°sica sobre tu tienda</h3>
    
        <label>Nombre del negocio</label>
        <input type="text" id="nombreNegocioMayIA" placeholder="Ej: Tienda El Rinc√≥n" />
    
        <label>¬øQu√© tipo de productos vendes?</label>
        <input type="text" id="productosVendidos" placeholder="Ej: Cosm√©ticos, electrodom√©sticos, comida r√°pida‚Ä¶" />
    
        <label>¬øQu√© tipo de tienda tienes?</label>
        <div class="assistant-selection" id="tipoTiendaSeleccion">
          <div class="assistant-option" data-tipo="fisica">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/tiendafisica.png" alt="Tienda f√≠sica">
            <h4>Tienda f√≠sica</h4>
          </div>
          <div class="assistant-option" data-tipo="linea">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/tiendalinea.png" alt="Tienda en l√≠nea">
            <h4>Tienda en l√≠nea</h4>
          </div>
          <div class="assistant-option" data-tipo="mixta">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/tiendalosdos.png" alt="Ambos">
            <h4>Ambos</h4>
          </div>
        </div>
    
        <div id="ciudadContainer" style="display:none;">
          <label>Ciudad(es) donde operas</label>
          <input type="text" id="ciudadMayIA" placeholder="Ej: Medell√≠n, Bogot√°" />
        </div>
  
        <button class="btn ca-btn-outline" onclick="volverPaso0()">‚Üê Regresar</button>
        <button class="btn" onclick="siguientePaso()">Siguiente</button>
      `;
    
      currentStep = 1;
      updateProgressBar(currentStep);
    
      // Gestion du clic sur type de tienda
      document.querySelectorAll('#tipoTiendaSeleccion .assistant-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('#tipoTiendaSeleccion .assistant-option').forEach(el => el.classList.remove('selected'));
          option.classList.add('selected');
          const tipoSeleccionado = option.getAttribute("data-tipo");
    
          // Affiche le champ ciudad sauf si tienda en l√≠nea
          const ciudadDiv = document.getElementById("ciudadContainer");
          ciudadDiv.style.display = (tipoSeleccionado === "linea") ? "none" : "block";
    
          // Stocker pour traitement final plus tard
          window.tipoTiendaMayIA = tipoSeleccionado;
        });
      });
    }
    
    function loadFormForSofIA() {
      dynamicContainer.innerHTML = `
        <h3>Informaci√≥n b√°sica sobre tu servicio</h3>
        <label>Nombre del negocio</label>
        <input type="text" id="nombreNegocioSofIA" placeholder="Ej: Est√©tica Sofi Belleza" />
    
        <label>¬øQu√© servicios ofreces?</label>
        <input type="text" id="serviciosOfrecidos" placeholder="Ej: U√±as, pesta√±as, masajes, reservas‚Ä¶" />
    
        <label>Ciudad donde operas</label>
        <input type="text" id="ciudadSofIA" placeholder="Ej: Barranquilla, Cali" />
  
        <button class="btn ca-btn-outline" onclick="volverPaso0()">‚Üê Regresar</button>
        <button class="btn" onclick="siguientePaso()">Siguiente</button>
      `;
      currentStep = 1;
      updateProgressBar(currentStep);
    }
    
    function siguientePaso() {
      if (currentStep === 1) {
        currentStep = 2;
        updateProgressBar(currentStep);
    
        const esMayIA = selectedAssistant === "mayia";
    
        const objetivos = esMayIA
          ? [
              "Responder preguntas sobre productos",
              "Promocionar nuevos productos",
              "Guiar al cliente hacia la compra",
              "Enviar enlaces a tienda virtual",
              "Compartir precios y formas de pago",
              "Ofrecer recomendaciones de productos",
            ]
          : [
              "Responder dudas sobre servicios",
              "Automatizar reservas o agendamientos",
              "Confirmar citas autom√°ticamente",
              "Guiar al cliente al contacto por WhatsApp",
              "Promover servicios destacados",
              "Reducir el trabajo del equipo humano",
            ];
    
        dynamicContainer.innerHTML = `
          <h3>üéØ ¬øCu√°les son los objetivos de tu asistente?</h3>
          <p>Selecciona los objetivos que deseas lograr con <strong>${esMayIA ? "MayIA" : "SofIA"}</strong>:</p>
    
          <div class="objetivo-selection">
            ${objetivos
              .map(
                (obj) => `
                <div class="objetivo-option">${obj}</div>
              `
              )
              .join("")}
          </div>
    
          <label style="margin-top: 20px; display: block;">
            Otro objetivo:
            <input type="text" id="inputOtro" placeholder="Especifica tu objetivo" />
          </label>
    
          <div style="margin-top: 30px;">
            <button class="btn ca-btn-outline" onclick="volverPaso1()">‚Üê Regresar</button>
            <button class="btn" onclick="siguientePaso()">Siguiente</button>
          </div>
        `;
    
        document.querySelectorAll(".objetivo-option").forEach((opt) => {
          opt.addEventListener("click", () => {
            opt.classList.toggle("selected");
          });
        });
      }
    
      else if (currentStep === 2) {
        currentStep = 3;
        updateProgressBar(currentStep);
    
        dynamicContainer.innerHTML = `
          <h3>‚ùì Preguntas frecuentes (FAQ)</h3>
          <p>A√±ade las preguntas que suelen hacer tus clientes y c√≥mo deseas que el asistente responda.</p>
    
          <div id="faqContainer">
            <div class="faq-item">
              <label>Pregunta</label>
              <input type="text" class="faq-pregunta" placeholder="Ej: ¬øCu√°nto cuesta el env√≠o?" />
              <label>Respuesta</label>
              <input type="text" class="faq-respuesta" placeholder="Ej: El env√≠o cuesta entre $8.000 y $12.000 seg√∫n tu ciudad." />
            </div>
          </div>
    
          <button class="btn ca-btn-outline" onclick="agregarFaq()">‚ûï A√±adir otra pregunta</button>
          <div style="margin-top: 30px;">
            <button class="btn ca-btn-outline" onclick="volverPaso2()">‚Üê Regresar</button>
            <button class="btn" onclick="siguientePaso()">Siguiente</button>
          </div>
        `;
      }
      else if (currentStep === 3) {
        currentStep = 4;
        updateProgressBar(currentStep);
    
        dynamicContainer.innerHTML = `
          <h3>üè™ Informaci√≥n del comercio</h3>
        
          <!-- Produits ou services -->
          <div id="productosServiciosContainer">
            <h4>Productos o servicios</h4>
            <div class="producto-item">
              <label>Nombre</label>
              <input type="text" class="producto-nombre" placeholder="Ej: Facial hidratante, Hamburguesa..." />
              <label>Precio</label>
              <input type="text" class="producto-precio" placeholder="Ej: $35.000" />
              <label>Descripci√≥n</label>
              <input type="text" class="producto-descripcion" placeholder="Ej: Limpieza profunda y masaje facial" />
            </div>
          </div>
          <button class="btn ca-btn-outline" onclick="agregarCampoExtra()">‚ûï A√±adir campo personalizado</button>
          <button class="btn ca-btn-outline" onclick="agregarProducto()">‚ûï A√±adir otro producto o servicio</button>
        
          <!-- Horaires -->
          <div class="form-subsection">
            <h4>‚è∞ Horarios de atenci√≥n</h4>
            ${["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"].map(dia => `
              <label>${dia}</label>
              <input type="text" id="horario-${dia.toLowerCase()}" placeholder="Ej: 9:00 - 18:00 o Cerrado" />
            `).join("")}
            <label>
              <input type="checkbox" id="trabajaFestivos" />
              ¬øTu negocio abre en d√≠as festivos?
            </label>
          </div>
        
          <!-- Contact -->
          <div class="form-subsection">
            <h4>üìû Informaci√≥n de contacto</h4>
            <label>WhatsApp</label>
            <input type="text" id="whatsapp" placeholder="Ej: +57 3001234567" />
            <label>Email</label>
            <input type="text" id="email" placeholder="Ej: contacto@tu-negocio.com" />
            <label>Sitio web</label>
            <input type="text" id="web" placeholder="Ej: www.tu-negocio.com" />
          </div>
        
          <div style="margin-top: 30px;">
            <button class="btn ca-btn-outline" onclick="volverPaso3()">‚Üê Regresar</button>
            <button class="btn" onclick="finalizarFormulario()">Finalizar configuraci√≥n</button>
          </div>
        `;
        }, 0);
      }
    }
    function repliegueUltimoProducto() {
      const items = document.querySelectorAll("#productosServiciosContainer .producto-item");
      const dernier = items[items.length - 1];
    
      const nombre = dernier.querySelector(".producto-nombre")?.value || "";
      const precio = dernier.querySelector(".producto-precio")?.value || "";
      const descripcion = dernier.querySelector(".producto-descripcion")?.value || "";
    
      const resumen = document.createElement("div");
      resumen.classList.add("producto-resumen");
      resumen.innerHTML = `
        <p><strong>${nombre}</strong> ‚Äì ${precio}</p>
        <p>${descripcion}</p>
      `;
    
      // Supprimer le formulaire et garder le r√©sum√©
      dernier.innerHTML = "";
      dernier.classList.add("producto-replegado");
      // üîß Correction ici
      dernier.appendChild(resumen);
    }
      
    function volverPaso0() {
      currentStep = 0;
      selectedAssistant = null;
      document.getElementById("step0").style.display = "block";
      dynamicContainer.innerHTML = "";
      updateProgressBar(0);
    }
    function volverPaso1() {
      currentStep = 1;
      updateProgressBar(currentStep);
      if (selectedAssistant === "mayia") {
        loadFormForMayIA();
      } else {
        loadFormForSofIA();
      }
    }
    function agregarFaq() {
      const container = document.getElementById("faqContainer");
      const faqHTML = `
        <div class="faq-item" style="margin-top: 20px;">
          <label>Pregunta</label>
          <input type="text" class="faq-pregunta" placeholder="Ej: ¬øCu√°l es el horario de atenci√≥n?" />
          <label>Respuesta</label>
          <input type="text" class="faq-respuesta" placeholder="Ej: De lunes a s√°bado, de 9am a 6pm." />
        </div>
      `;
      container.insertAdjacentHTML("beforeend", faqHTML);
    }
    
    function volverPaso2() {
      currentStep = 2;
      updateProgressBar(currentStep);
    
      const esMayIA = selectedAssistant === "mayia";
    
      const objetivos = esMayIA
        ? [
            "Responder preguntas sobre productos",
            "Promocionar nuevos productos",
            "Guiar al cliente hacia la compra",
            "Enviar enlaces a tienda virtual",
            "Compartir precios y formas de pago",
            "Ofrecer recomendaciones de productos",
          ]
        : [
            "Responder dudas sobre servicios",
            "Automatizar reservas o agendamientos",
            "Confirmar citas autom√°ticamente",
            "Guiar al cliente al contacto por WhatsApp",
            "Promover servicios destacados",
            "Reducir el trabajo del equipo humano",
          ];
    
      dynamicContainer.innerHTML = `
        <h3>üéØ ¬øCu√°les son los objetivos de tu asistente?</h3>
        <p>Selecciona los objetivos que deseas lograr con <strong>${esMayIA ? "MayIA" : "SofIA"}</strong>:</p>
    
        <div class="objetivo-selection">
          ${objetivos
            .map(
              (obj) => `
              <div class="objetivo-option">${obj}</div>
            `
            )
            .join("")}
        </div>
    
        <label style="margin-top: 20px; display: block;">
          Otro objetivo:
          <input type="text" id="inputOtro" placeholder="Especifica tu objetivo" />
        </label>
    
        <div style="margin-top: 30px;">
          <button class="btn ca-btn-outline" onclick="volverPaso1()">‚Üê Regresar</button>
          <button class="btn" onclick="siguientePaso()">Siguiente</button>
        </div>
      `;
    
      document.querySelectorAll(".objetivo-option").forEach((opt) => {
        opt.addEventListener("click", () => {
          opt.classList.toggle("selected");
        });
      });
    }
    function volverPaso3() {
      currentStep = 3;
      updateProgressBar(currentStep);
    
      dynamicContainer.innerHTML = `
        <h3>‚ùì Preguntas frecuentes (FAQ)</h3>
        <p>A√±ade las preguntas que suelen hacer tus clientes y c√≥mo deseas que el asistente responda.</p>
    
        <div id="faqContainer">
          <div class="faq-item">
            <label>Pregunta</label>
            <input type="text" class="faq-pregunta" placeholder="Ej: ¬øCu√°nto cuesta el env√≠o?" />
            <label>Respuesta</label>
            <input type="text" class="faq-respuesta" placeholder="Ej: El env√≠o cuesta entre $8.000 y $12.000 seg√∫n tu ciudad." />
          </div>
        </div>
    
        <button class="btn ca-btn-outline" onclick="agregarFaq()">‚ûï A√±adir otra pregunta</button>
        <div style="margin-top: 30px;">
          <button class="btn ca-btn-outline" onclick="volverPaso2()">‚Üê Regresar</button>
          <button class="btn" onclick="siguientePaso()">Siguiente</button>
        </div>
      `;
    }
    function agregarProducto() {
      repliegueUltimoProducto(); // üîß Ajoute ici
    
      const container = document.getElementById("productosServiciosContainer");
      const block = document.createElement("div");
      block.classList.add("producto-item");
      block.style.marginTop = "20px";
      block.innerHTML = `
        <label>Nombre</label>
        <input type="text" class="producto-nombre" placeholder="Ej: Corte de cabello, Combo #2..." />
        <label>Precio</label>
        <input type="text" class="producto-precio" placeholder="Ej: $15.000" />
        <label>Descripci√≥n</label>
        <input type="text" class="producto-descripcion" placeholder="Ej: Corte moderno para hombre" />
      `;
      container.appendChild(block);
      actualizarCamposProducto(block); // Garde bien cette ligne aussi
    }
    // V√©rif auth
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        if (!res.ok) throw new Error("No autenticado");
        const data = await res.json();
        document.getElementById("auth-buttons").innerHTML = `üëã Hola, ${data.name}`;
        showStep0();
    
        // üîÅ Ajoute ceci
        document.getElementById("mayia").addEventListener("click", () => {
          selectedAssistant = "mayia";
          document.getElementById("mayia").classList.add("selected");
          document.getElementById("sofia").classList.remove("selected");
        
          // Masquer l‚Äô√©tape 0
          document.getElementById("step0").style.display = "none";
        
          loadFormForMayIA();
        });
        
        document.getElementById("sofia").addEventListener("click", () => {
          selectedAssistant = "sofia";
          document.getElementById("sofia").classList.add("selected");
          document.getElementById("mayia").classList.remove("selected");
        
          // Masquer l‚Äô√©tape 0
          document.getElementById("step0").style.display = "none";
        
          loadFormForSofIA();
        });
    
      } catch (err) {
        window.location.href = "login.html";
      }
    });
      async function finalizarFormulario() {
        try {
          const cookies = document.cookie.split(';').reduce((acc, c) => {
            const [key, val] = c.trim().split('=');
            acc[key] = val;
            return acc;
          }, {});
          const token = cookies.token;
          if (!token) {
            alert("No has iniciado sesi√≥n.");
            return;
          }
      
          const nombre = document.getElementById("nombreNegocioMayIA")?.value || document.getElementById("nombreNegocioSofIA")?.value;
          const tipo = selectedAssistant === "mayia"
            ? document.getElementById("productosVendidos").value
            : document.getElementById("serviciosOfrecidos").value;
          const ciudad = selectedAssistant === "mayia"
            ? document.getElementById("ciudadMayIA")?.value || "toda Colombia"
            : document.getElementById("ciudadSofIA")?.value;
          const venta = window.tipoTiendaMayIA || "f√≠sica";
      
          const objetivos = Array.from(document.querySelectorAll(".objetivo-option.selected")).map(el => el.textContent.trim());
          const otro = document.getElementById("inputOtro")?.value;
          if (otro) objetivos.push(otro);
      
          const faqPairs = Array.from(document.querySelectorAll(".faq-item")).map(faq => {
            const pregunta = faq.querySelector(".faq-pregunta").value;
            const respuesta = faq.querySelector(".faq-respuesta").value;
            return `Q: ${pregunta}\nA: ${respuesta}`;
          });
      
          const productosData = Array.from(document.querySelectorAll(".producto-item")).map(block => {
            const nombre = block.querySelector(".producto-nombre")?.value || "";
            const precio = block.querySelector(".producto-precio")?.value || "";
            const descripcion = block.querySelector(".producto-descripcion")?.value || "";
            const otros = {};
            block.querySelectorAll("input").forEach(input => {
              if (!["producto-nombre", "producto-precio", "producto-descripcion"].some(cls => input.classList.contains(cls))) {
                otros[input.className] = input.value;
              }
            });
            return { nombre, precio, descripcion, ...otros };
          });
      
          const productosTexto = productosData.map(p => {
            const extras = Object.entries(p)
              .filter(([k]) => !["nombre", "precio", "descripcion"].includes(k))
              .map(([k, v]) => ` - ${k}: ${v}`)
              .join("\n");
            return `üõí ${p.nombre} ‚Äì ${p.precio}\n${p.descripcion}\n${extras}`;
          }).join("\n\n");
      
          const horarios = [
            "lunes", "martes", "mi√©rcoles", "jueves", "viernes", "s√°bado", "domingo"
          ].map(dia =>
            `${dia.charAt(0).toUpperCase() + dia.slice(1)}: ${document.getElementById("horario-" + dia)?.value || "No definido"}`
          ).join("\n");
      
          const festivos = document.getElementById("trabajaFestivos").checked;
          const whatsapp = document.getElementById("whatsapp").value;
          const email = document.getElementById("email").value;
          const web = document.getElementById("web").value;
      
          const instructions = `
      I/ Informaci√≥n del Asistente
      I.i/ Contexto
      ${nombre} es un negocio de ${tipo} y que vende ${venta}.
      ${nombre} se encuentra en ${ciudad}.
      
      I.ii/ Objetivos
      Los objetivos principales de ${nombre} son:
      ${objetivos.map(o => "- " + o).join("\n")}
      
      II/ Funciones
      II.i/ Preguntas frecuentes
      ${faqPairs.join("\n\n")}
      
      III/ Informaci√≥n del comercio
      III.i/ Informaci√≥n de los ${venta}
      ${productosTexto}
      
      III.ii/ Horarios
      ${horarios}
      ${nombre} ${festivos ? "s√≠" : "no"} est√° abierto en d√≠as festivos.
      
      III.iii/ Contactos
      WhatsApp: ${whatsapp}
      Email: ${email}
      Sitio Web: ${web}
      
      IV/ Notas Internas para Clasificaci√≥n de Conversaciones
      --- Nota interna ---
      Resumen: [Una frase breve que resuma el prop√≥sito de la conversaci√≥n]
      Estado: [Acci√≥n requerida / Nada que hacer / Conversaci√≥n informativa / Potencial cliente / Seguimiento recomendado]
      ---------------------
      `.trim();
      
          const assistantData = {
            nombre, tipo, ciudad, venta, objetivos, faq: faqPairs,
            productos: productosData, horarios, festivos, whatsapp, email, web
          };
      
          const response = await fetch("/api/configurar-instrucciones", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + token
            },
            body: JSON.stringify({ instructions, assistantData })
          });
      
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Error desconocido");
          }
      
          window.location.href = "dashboard.html";
        } catch (e) {
          console.error("‚ùå Error en finalizarFormulario():", e);
          alert("Error al guardar la configuraci√≥n.");
        }
      }
    }
  </script>
</body>
</html>
