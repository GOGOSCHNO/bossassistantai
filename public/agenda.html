<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda â€“ Comercio AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="comercioai.css">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
  <link rel="icon" href="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png">
</head>
<body class="agenda-page">
  <div class="overlay">
    <header class="ca-header">
      <div class="ca-header-3col">
        <div class="ca-header-left">
          <a href="index.html" class="ca-logo-icon">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" alt="Logo Cerveau">
          </a>
          <a href="index.html" class="ca-logo-text-img">
            <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="Logo ComercioAI">
          </a>
        </div>
        <nav class="ca-header-center">
          <a href="dashboard.html" class="ca-btn nav-btn">Dashboard</a>
          <a href="editar-asistente.html" class="ca-btn nav-btn">Editar Asistente</a>
        </nav>
        <div id="auth-buttons" class="ca-header-right">
          <!-- Rempli dynamiquement par JS -->
        </div>
      </div>
    </header>

    <main>
      <div id='calendar'></div>
      <div id="eventPopup" class="event-popup hidden">
        <div class="popup-header">
          <strong id="popupTitle"></strong>
          <button id="editBtn">âœï¸</button>
          <button id="deleteBtn">ğŸ—‘ï¸</button>
        </div>
        <div class="popup-body">
          <p><strong>ğŸ“… Fecha:</strong> <span id="popupDate"></span></p>
          <p><strong>ğŸ•’ Hora:</strong> <span id="popupTime"></span></p>
          <p><strong>ğŸ“ TelÃ©fono:</strong> <span id="popupPhone"></span></p>
          <p><strong>ğŸ’¬ Servicio:</strong> <span id="popupService"></span></p>
        </div>
      </div>
    </main>

    <footer class="ca-footer">
      &copy; 2025 Comercio AI â€“ Todos los derechos reservados.
      <a href="contacto.html">ContÃ¡ctanos</a>
      <a href="politica-de-privacidad.html" target="_blank">PolÃ­tica de Privacidad</a>
      <a href="eliminar-datos.html" target="_blank">Eliminar mis datos</a>
    </footer>
  </div>

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'es',
        
        // ğŸ”½ AJOUTE ICI L'Ã‰VÃ‰NEMENT AU CLIC
        eventClick: function(info) {
          const numero = info.event.extendedProps.phoneNumber;
          if (numero) {
            window.location.href = `dashboard.html?phone=${encodeURIComponent(numero)}`;
          }
        },
        
        events: await cargarEventos()
      });

      calendar.render();
    });

    async function cargarEventos() {
      try {
        const res = await fetch('/api/mis-citas', { credentials: 'include' });
        const data = await res.json();
        if (!Array.isArray(data)) return [];
        return data.map(evt => ({
          title: evt.customerName + ' â€“ ' + evt.service,
          start: evt.date + 'T' + evt.startTime,
          end: evt.date + 'T' + evt.endTime,
          phoneNumber: evt.phoneNumber // ğŸ‘ˆ important
        }));
      } catch (err) {
        console.error('âŒ Error al cargar eventos:', err);
        return [];
      }
    }
    async function loadUserName() {
      const authDiv = document.getElementById("auth-buttons");
      try {
        const res = await fetch("/api/me", { credentials: "include" });
        const data = await res.json();
        if (res.ok) {
          authDiv.innerHTML = `
            <div id="user-info" style="cursor: pointer; font-weight: bold;">ğŸ‘‹ Hola, ${data.name}</div>
            <button id="logout-btn" class="auth-btn">Cerrar sesiÃ³n</button>
          `;
          document.getElementById("logout-btn").addEventListener("click", async () => {
            await fetch("/api/logout", { method: "POST", credentials: "include" });
            window.location.reload();
          });
        } else {
          authDiv.innerHTML = `<a href="login.html" class="auth-btn">Iniciar sesiÃ³n</a>`;
        }
      } catch (err) {
        console.error("Error auth:", err);
        authDiv.innerHTML = `<a href="login.html" class="auth-btn">Iniciar sesiÃ³n</a>`;
      }
    }
  
    document.addEventListener("DOMContentLoaded", loadUserName);
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');
      const popup = document.getElementById('eventPopup');
    
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'es',
        events: await cargarEventos(),
    
        eventClick: function(info) {
          const event = info.event;
          const { customerName, phoneNumber, service, date, startTime, endTime, _id } = event.extendedProps;
    
          document.getElementById('popupTitle').textContent = `Cita de ${customerName}`;
          document.getElementById('popupDate').textContent = date;
          document.getElementById('popupTime').textContent = `${startTime} â€“ ${endTime}`;
          document.getElementById('popupPhone').textContent = phoneNumber;
          document.getElementById('popupService').textContent = service;
    
          // Position de la popup (clique souris)
          const mouseX = info.jsEvent.pageX;
          const mouseY = info.jsEvent.pageY;
          popup.style.left = `${mouseX + 10}px`;
          popup.style.top = `${mouseY}px`;
    
          popup.classList.remove('hidden');
    
          // Actions
          document.getElementById('deleteBtn').onclick = () => supprimerCita(_id, event);
          document.getElementById('editBtn').onclick = () => alert("ğŸ‘‰ ici on ouvrira le formulaire de modification");
        }
      });
    
      document.addEventListener("click", function(e) {
        if (!popup.contains(e.target)) {
          popup.classList.add('hidden');
        }
      });
    
      calendar.render();
    });
    async function supprimerCita(id, eventObj) {
      const ok = confirm("Â¿Seguro que deseas eliminar esta cita?");
      if (!ok) return;
      const res = await fetch("/api/eliminar-cita", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ appointmentId: id })
      });
      const data = await res.json();
      if (data.success) {
        eventObj.remove(); // Retire visuellement
        document.getElementById("eventPopup").classList.add("hidden");
        alert("âœ… Cita eliminada");
      } else {
        alert("âŒ Error al eliminar la cita");
      }
    }
  </script>
</body>
</html>
