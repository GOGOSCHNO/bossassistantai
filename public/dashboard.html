<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard ‚Äì Comercio AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="comercioai.css">
  <link rel="icon" href="https://raw.githubusercontent.com/GOGOSCHNO/assistantai-site/refs/heads/main/images/favicon%20(2).png" type="image/x-icon">
</head>
<body>
  <div class="overlay">
    <header class="header">
      <div class="branding">
        <a href="index.html">
          <img src="https://raw.githubusercontent.com/GOGOSCHNO/bossassistantai/refs/heads/main/public/images/ComercioAI_logotexte%20sans%20fonds.png" alt="ComercioAI Logo">
        </a>
        <p class="slogan">Chatbots & Soluciones de IA para tu negocio</p>
      </div>
      <div id="auth-buttons"></div>
    </header>

    <main>
      <div class="dashboard-wrapper">
        <!-- Section 1: Liste des conversations -->
        <aside class="conversation-list">
          <h3>üì± Conversaciones</h3>
          <ul id="conversationList"></ul>
        </aside>

        <!-- Section 2: D√©tail de la conversation -->
        <section class="conversation-details">
          <h3>üí¨ Detalles de la conversaci√≥n</h3>
          <div id="conversationMessages"></div>
        </section>

        <!-- Section 3: Informations suppl√©mentaires -->
        <aside class="contact-info">
          <h3>‚ÑπÔ∏è Info Cliente</h3>
          <p><strong>Estado:</strong> <span id="estadoInfo">---</span></p>
          <p><strong>Resumen:</strong> <span id="resumenInfo">---</span></p>
        </aside>
      </div>
    </main>

    <footer class="ca-footer">
      &copy; 2025 Comercio AI ‚Äì Todos los derechos reservados.
      <a href="contacto.html">Cont√°ctanos</a>
      <a href="politica-de-privacidad.html" target="_blank">Pol√≠tica de Privacidad</a>
      <a href="eliminar-datos.html" target="_blank">Eliminar mis datos</a>
    </footer>
  </div>

  <script>
    let allConversations = [];

    async function loadUserName() {
      const authDiv = document.getElementById("auth-buttons");
      try {
        const res = await fetch("https://bossassistantai-439c88409c33.herokuapp.com/api/me", {
          credentials: "include"
        });
        const data = await res.json();
        if (res.ok) {
          authDiv.innerHTML = `
            <div id="user-info" style="cursor: pointer; font-weight: bold;">üëã Hola, ${data.name}</div>
            <button id="logout-btn" class="auth-btn">Cerrar sesi√≥n</button>
          `;
          document.getElementById("logout-btn").addEventListener("click", async () => {
            await fetch("https://bossassistantai-439c88409c33.herokuapp.com/api/logout", {
              method: "POST", credentials: "include"
            });
            window.location.reload();
          });
        }
      } catch {
        authDiv.innerHTML = `
          <a href="signup.html" class="auth-btn">Crear cuenta</a>
          <a href="login.html" class="auth-btn">Iniciar sesi√≥n</a>
        `;
      }
    }

    async function loadConversations() {
      try {
        const res = await fetch("https://bossassistantai-439c88409c33.herokuapp.com/api/mes-conversations", {
          credentials: "include"
        });
        const data = await res.json();
        allConversations = data.conversations;

        const list = document.getElementById("conversationList");
        list.innerHTML = "";

        allConversations.forEach((conv, index) => {
          const li = document.createElement("li");
          li.className = "conversation-item";
          li.textContent = conv.userNumber;
          li.addEventListener("click", () => displayConversation(index));
          list.appendChild(li);
        });
      } catch (err) {
        console.error("Error al cargar las conversaciones:", err);
      }
    }

    function displayConversation(index) {
      const conv = allConversations[index];
      const messagesDiv = document.getElementById("conversationMessages");
      const estadoSpan = document.getElementById("estadoInfo");
      const resumenSpan = document.getElementById("resumenInfo");

      messagesDiv.innerHTML = conv.responses.map(entry => `
        <div class="message-block">
          <p><strong>Cliente:</strong> ${entry.userMessage}</p>
          <p><strong>Asistente:</strong> ${entry.assistantResponse?.text || ""}</p>
          <small>${new Date(entry.timestamp).toLocaleString("es-CO")}</small>
          <hr>
        </div>
      `).join("");

      const last = conv.responses[conv.responses.length - 1];
      resumenSpan.textContent = last?.assistantResponse?.note?.summary || "---";
      estadoSpan.textContent = last?.assistantResponse?.note?.status || "---";
    }

    loadUserName();
    loadConversations();
  </script>
</body>
</html>
